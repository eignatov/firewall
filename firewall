#!/bin/sh
# Author: Filip Valder (filip.valder@vsb.cz)
# Date: 5.11.2012
# Description: Start/stop/save script for both ipv4 and ipv6 firewall

CONF=/etc/firewall.conf
DATE=`date`
FULL_PATH=`readlink -f $0`
IP6TABLES=/sbin/ip6tables
IPTABLES=/sbin/iptables
RESTORE6=/sbin/ip6tables-restore
RESTORE=/sbin/iptables-restore
SAVE6=/sbin/ip6tables-save
SAVE=/sbin/iptables-save

case "$1" in
	start|restart)
		[ "$1" = "start" ] && echo -n "Starting firewall..."
		[ "$1" = "restart" ] && echo -n "Restarting firewall..."
		$IP6TABLES -F
		$IP6TABLES -X
		$IP6TABLES -Z
		$IP6TABLES -P INPUT ACCEPT
		$IP6TABLES -P FORWARD ACCEPT
		$IP6TABLES -P OUTPUT ACCEPT
		$IPTABLES -F
		$IPTABLES -X
		$IPTABLES -Z
		$IPTABLES -P INPUT ACCEPT
		$IPTABLES -P FORWARD ACCEPT
		$IPTABLES -P OUTPUT ACCEPT
		cat $CONF | sed '/Generated by iptables-save/,$d' | $RESTORE6
		cat $CONF | sed '/Generated by iptables-save/,$!d' | $RESTORE
	;;
	stop)
		echo -n "Stopping firewall..."
		$IP6TABLES -F
		$IP6TABLES -X
		$IP6TABLES -Z
		$IP6TABLES -P INPUT ACCEPT
		$IP6TABLES -P FORWARD ACCEPT
		$IP6TABLES -P OUTPUT ACCEPT
		$IPTABLES -F
		$IPTABLES -X
		$IPTABLES -Z
		$IPTABLES -P INPUT ACCEPT
		$IPTABLES -P FORWARD ACCEPT
		$IPTABLES -P OUTPUT ACCEPT
	;;
	save)
		echo -n "Saving rules..."
		echo "# Generated by $FULL_PATH on $DATE\n" > $CONF
		{ ip6tables-save ; iptables-save ; } >> $CONF
	;;
	*)
		echo "Usage: $0 {start|stop|restart|save}"
		exit 1
	;;
esac
echo "done."
exit 0
